<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Microservice Dashboard</title>
  <style>
    :root {
      --bg-color: #121212;
      --text-color: #f5f5f5;
      --card-bg: #1f1f1f;
      --accent: #00ffb7;
      --table-border: #333;
      --button-text: white;
      --shadow-color: rgba(0, 255, 183, 0.4);
      --input-border: #00ffb7;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Segoe UI', sans-serif;
      transition: background-color 0.3s ease, color 0.3s ease;
      padding: 20px;
    }

    h1 {
      text-align: center;
      color: var(--accent);
      font-size: 2em;
      margin-bottom: 25px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      text-shadow: 0 0 8px var(--shadow-color);
    }

    /* üîÅ Reset Button */
    #resetBtn {
      position: fixed;
      top: 20px;
      left: 25px;
      background-color: crimson;
      color: white;
      border: none;
      padding: 8px 18px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.4);
      transition: 0.3s;
    }
    #resetBtn:hover {
      background-color: darkred;
      box-shadow: 0 0 15px rgba(255, 0, 0, 0.6);
    }

    /* üí∞ Revenue Card */
    .revenue-card {
      background-color: var(--card-bg);
      color: var(--accent);
      text-align: center;
      padding: 15px;
      margin: 0 auto 25px;
      max-width: 400px;
      border-radius: 15px;
      font-size: 1.3em;
      border: 2px solid var(--accent);
      box-shadow: 0 0 15px var(--shadow-color);
    }

    form {
      background-color: var(--card-bg);
      padding: 20px;
      margin: 10px auto;
      border-radius: 10px;
      max-width: 900px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 0 10px var(--shadow-color);
      gap: 12px;
      flex-wrap: wrap;
    }

    input, select {
      padding: 10px;
      border: 2px solid var(--input-border);
      border-radius: 6px;
      width: 250px;
      background-color: var(--bg-color);
      color: var(--text-color);
      outline: none;
      transition: 0.3s;
      box-shadow: inset 0 0 5px var(--shadow-color);
    }

    input::placeholder { color: #aaa; }

    /* Buttons */
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      color: var(--button-text);
    }
    .btn-user    { background-color: #007bff; }
    .btn-user:hover    { background-color: #0056b3; }
    .btn-product { background-color: #28a745; }
    .btn-product:hover { background-color: #1c7c31; }
    .btn-order   { background-color: #ffc107; color: #111; }
    .btn-order:hover   { background-color: #d39e00; }

    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background-color: var(--card-bg);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 10px var(--shadow-color);
    }
    th {
      background-color: var(--table-border);
      color: var(--accent);
      padding: 10px;
      text-align: left;
    }
    td {
      padding: 10px;
      border-bottom: 1px solid var(--table-border);
    }

    .section {
      max-width: 900px;
      margin: 30px auto;
    }
    .section h2 {
      color: var(--accent);
      border-bottom: 2px solid var(--accent);
      padding-bottom: 5px;
    }
  </style>
</head>

<body>
  <button id="resetBtn" onclick="resetDashboard()">üîÑ Reset</button>
  <h1>‚öôÔ∏è Microservice Dashboard</h1>

  <!-- üí∞ Total Revenue (safe calculation) -->
  {% set ns = namespace(total=0.0) %}
  {% for order in orders %}
    {% set prod = (order.product if order.product is defined else (order["product"] if order["product"] is defined else {})) %}
    {% set price_val = (
      prod.price if prod.price is defined
      else (prod["price"] if prod["price"] is defined else 0)
    ) %}
    {% set price_val = price_val | float %}
    {% set ns.total = ns.total + price_val %}
  {% endfor %}
  <div class="revenue-card">
    üí∞ Total Revenue: ‚Çπ {{ "{:,.2f}".format(ns.total) }}
  </div>

  <!-- üë• Add User -->
  <form action="/add_user" method="POST">
    <input type="text" name="name" placeholder="Enter user name" required />
    <button type="submit" class="btn-user">Add User</button>
  </form>

  <!-- üì¶ Add Product -->
  <form action="/add_product" method="POST">
    <input type="text" name="name" placeholder="Product name" required />
    <input type="number" step="0.01" name="price" placeholder="Price" required />
    <button type="submit" class="btn-product">Add Product</button>
  </form>

  <!-- üßæ Add Order -->
  <form action="/add_order" method="POST">
    <select name="user_id" required>
      <option value="">Select User</option>
      {% for user in users %}
        <option value="{{ user.id }}">{{ user.name }}</option>
      {% endfor %}
    </select>

    <select name="product_id" required>
      <option value="">Select Product</option>
      {% for product in products %}
        <option value="{{ product.id }}">{{ product.name }}</option>
      {% endfor %}
    </select>

    <button type="submit" class="btn-order">Create Order</button>
  </form>

  <!-- üßë‚Äçüíº Users -->
  <div class="section">
    <h2>üë• Users</h2>
    <table>
      <tr><th>ID</th><th>Name</th></tr>
      {% for user in users %}
        <tr><td>{{ user.id }}</td><td>{{ user.name }}</td></tr>
      {% endfor %}
    </table>
  </div>

  <!-- üì¶ Products -->
  <div class="section">
    <h2>üì¶ Products</h2>
    <table>
      <tr><th>ID</th><th>Name</th><th>Price</th></tr>
      {% for product in products %}
        {% set p = product %}
        {% set price_val = (p.price if p.price is defined else (p["price"] if p["price"] is defined else 0)) | float %}
        <tr>
          <td>{{ p.id }}</td>
          <td>{{ p.name }}</td>
          <td>‚Çπ{{ "{:,.2f}".format(price_val) }}</td>
        </tr>
      {% endfor %}
    </table>
  </div>

  <!-- üßæ Orders -->
  <div class="section">
    <h2>üßæ Orders</h2>
    <table>
      <tr><th>Order ID</th><th>User</th><th>Product</th><th>Price</th></tr>
      {% for order in orders %}
        {% set prod = (order.product if order.product is defined else (order["product"] if order["product"] is defined else {})) %}
        {% set prod_name = (prod.name if prod.name is defined else (prod["name"] if prod["name"] is defined else prod)) %}
        {% set price_val = (
          prod.price if prod.price is defined
          else (prod["price"] if prod["price"] is defined else 0)
        ) | float %}
        <tr>
          <td>{{ order.order_id }}</td>
          <td>{{ order.user.name if order.user.name is defined else (order.user["name"] if order.user["name"] is defined else "Unknown") }}</td>
          <td>{{ prod_name }}</td>
          <td>‚Çπ{{ "{:,.2f}".format(price_val) }}</td>
        </tr>
      {% endfor %}
    </table>
  </div>

  <script>
    // üîÅ Reset Dashboard
    function resetDashboard() {
      if (confirm("Are you sure you want to reset the dashboard? This will delete all data.")) {
        fetch("/reset", { method: "DELETE" })
          .then(res => {
            if (res.ok) {
              alert("‚úÖ Dashboard reset successfully!");
              window.location.reload();
            } else {
              alert("‚ùå Failed to reset dashboard.");
            }
          })
          .catch(() => alert("‚ö†Ô∏è Error connecting to server."));
      }
    }
  </script>
</body>
</html>
